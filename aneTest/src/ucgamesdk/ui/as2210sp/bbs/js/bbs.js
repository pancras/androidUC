S.SSCL.BBS=Backbone.Collection.extend({initialize:function(){this.API={GetAllTopics:eConfig.bbsServerUrl+"/"+rConfig.apis.BBS_GET_TOPICS,GetRecentTopics:eConfig.bbsServerUrl+"/"+rConfig.apis.BBS_GET_NEW_TOPICS,GetEliteTopics:eConfig.bbsServerUrl+"/"+rConfig.apis.BBS_GET_ELITE_TOPICS,GetTopTopics:eConfig.bbsServerUrl+"/"+rConfig.apis.BBS_GET_TOP_TOPICS,SearchTopics:eConfig.bbsServerUrl+"/"+rConfig.apis.BBS_SEARCH_BOARD_TOPICS,GetTopicsByGroup:eConfig.bbsServerUrl+"/"+rConfig.apis.BBS_GET_TOPICS_BY_GROUP,
GetReplies:eConfig.bbsServerUrl+"/"+rConfig.apis.BBS_GET_REPLIES};this.url=this.API.GetTopTopics},fetch:function(a){a=a||{};this._setUrl(a.data.type);delete a.data.type;this.reset();Backbone.Collection.prototype.fetch.call(this,a)},getReplies:function(){this.reset();this.url=this.API.GetReplies;Backbone.Collection.prototype.fetch.apply(this,arguments)},parse:function(a){if(!_.isUndefined(a)&&!_.isEmpty(a))return this.totalCount=a.data.totalCount,this.pageCount=Math.ceil(a.data.totalCount/rConfig.bbs.listPerPage),
this.subPageCount=Math.ceil(a.data.totalCount/rConfig.bbs.listSubPage),a.data.list},_setUrl:function(a){switch(a){case "all":this.url=this.API.GetAllTopics;break;case "good":this.url=this.API.GetEliteTopics;break;case "exp":this.url=this.API.GetTopicsByGroup;break;case "test":this.url=this.API.GetTopicsByGroup;break;case "ask":this.url=this.API.GetTopicsByGroup;break;case "mood":this.url=this.API.GetTopicsByGroup;break;case "advise":this.url=this.API.GetTopicsByGroup;break;case "new":this.url=this.API.GetRecentTopics;
break;case "search":this.url=this.API.SearchTopics;break;case "toplist":this.url=this.API.GetTopTopics;break;default:console.log("type "+a+"not exist, use all instead."),this.url=this.API.GetAllTopics}}});S.SSCT.BBS=Backbone.Controller.extend({gameId:0,boardId:0,totalPages:0,totalNum:0,cache:{},curUser:"",initialize:function(){_.bindAll(this);this._getCurUserInfo()},getBoardInfo:function(a,b){this.gameId=a.gameId||this.gameId;var c=this.getCache("Board","boardInfo&gameId="+this.gameId,!1);if(!_.isUndefined(c)&&!_.isEmpty(c))return b&&b.success?b.success.call(this,c):!1;S.SSCT.GetHandler("Model","BBS").getBoard({data:{ucid:this.curUser.ucid,gameid:this.gameId},success:$.proxy(function(a,c){_.isEmpty(c.data)?
b.error.apply(this,["\u8bfb\u53d6\u4fe1\u606f\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5"]):(this.setCache("Board","boardInfo&gameId="+this.gameId,c.data,rConfig.bbs.cacheTime.board,!1),this.boardId=c.data.boardId,b.success.apply(this,[c.data]))},this),error:$.proxy(function(){b.error.apply(this,["\u83b7\u53d6\u7248\u5757\u4fe1\u606f\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5"])},this),quiet:!0})},getBoardIndexInfo:function(a,b){this.gameId=a.gameId||this.gameId;var c=a.page||1,d=a.count||rConfig.bbs.listSubPage,
e="boardIndexInfo&gameId="+this.gameId+"&page="+c+"&count="+d,f="boardInfo&gameId="+this.gameId,g=1===c?!0:!1,h=this.getCache("Board",e,!1);if(!this.gameId)return b.error?b.error.apply(this,["a gameId must be provided"]):!1;if(!_.isUndefined(h)&&!_.isEmpty(h))return b&&b.success?b.success.call(this,this._processBoardIndexInfo(h)):!1;S.SSCT.GetHandler("Model","BBS").getBoardIndexInfo({data:{ucid:this.curUser.ucid,gameid:this.gameId,page:c,count:d},success:$.proxy(function(a,c){_.isEmpty(c.data)?b.error.apply(this,
["\u8bfb\u53d6\u4fe1\u606f\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5"]):(g&&this.setCache("Board",e,c.data,rConfig.bbs.cacheTime.index,!1),this.setCache("Board",f,c.data.stats,rConfig.bbs.cacheTime.board,!1),this.boardId=c.data.stats.boardId,b.success.apply(this,[this._processBoardIndexInfo(c.data)]))},this),error:$.proxy(function(){b.error.apply(this,["\u8bfb\u53d6\u4fe1\u606f\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5"])},this),quiet:!0})},getListData:function(a,b,c,d){var d=d||{},e="",f={},g=this;switch(a){case "exp":e=
rConfig.bbs.group.exp;break;case "test":e=rConfig.bbs.group.test;break;case "ask":e=rConfig.bbs.group.ask;break;case "mood":e=rConfig.bbs.group.mood;break;case "advise":e=rConfig.bbs.group.advise}a={type:a,boardid:this.boardId,page:b,count:c};if(!_.isNull(e)&&""!==e)a.group=parseInt(e);if(d.success)f.success=function(a){d.success.apply(this,[g._processTopics(a)])};if(d.error)f.error=d.error;this._getData(a,f)},getTopicData:function(a){var a=a||{},b={},c=this;if(a.success)b.success=function(b){a.success.apply(this,
[c._processToplist(b)])};if(a.error)b.error=a.error;this._getData({type:"toplist",boardid:this.boardId},b)},getSearchData:function(a,b,c,d){var d=d||{},e={},f=this,b={type:"search",boardid:this.boardId,page:b,count:c};_.isUndefined(a)?d.error.apply(this,[[],{msg:"\u5173\u952e\u8bcd\u4e0d\u80fd\u4e3a\u7a7a"}]):b.keyword=decodeURIComponent(a);if(d.success)e.success=function(a){d.success.apply(this,[f._processTopics(a)])};if(d.error)e.error=d.error;this._getData(b,e)},_getData:function(a,b){var c=S.SSCT.GetHandler("Collection",
"BBS"),d=rConfig.bbs.cacheTime.index,e=a.boardid,f=a.group,g=a.type,h=!0,i,j,k;_.isUndefined(a.page)?(i="topPage",j="topCount"):_.isUndefined(a.keyword)?(i=a.page,j=a.count,h=1==i||2==i||j==rConfig.bbs.listPerIndexPage?!0:!1):h=!1;if(h&&(_.isUndefined(f)&&(f="all"),k="boardId="+e+"&type="+g+"&group="+f+"&page="+i+"&count="+j,e=this.getCache("Collection",k,!1),!_.isUndefined(e)&&!_.isEmpty(e))){c.reset(e.data.list);c.parse(e);if("topPage"!=i)this.totalPages=c.pageCount,this.totalNum=c.totalCount,this.subPageCount=
c.subPageCount;b&&b.success&&b.success.call(this,c,{success:!0,msg:"fetch bbs collection success."});return}a.ucid=this.curUser.ucid;c.fetch({data:a,success:$.proxy(function(a,c){h&&this.setCache("Collection",k,c,d,!1);if("topPage"!=i)this.totalPages=a.pageCount,this.totalNum=a.totalCount,this.subPageCount=a.subPageCount;b.success.apply(this,[a,c])},this),error:b.error,quiet:!0})},_processTopics:function(a){var b=[],c,d,e,f,g,h;for(g=0,h=a.length;g<h;g++){d=a.at(g);c=d.get("userName");if(!c||""==
c)c="UC\u7528\u6237"+d.get("uid");c={topicId:d.get("topicId"),title:d.get("title"),userName:c,replyCount:d.get("replyCount"),hitCount:d.get("hitCount"),className:[],words:[]};e=d.get("isElite");f=d.get("isClosed");d=d.get("topicType");!_.isUndefined(e)&&!0==e&&(c.className.push("grn"),c.words.push("\u7cbe\u534e"));!_.isUndefined(f)&&!0==f&&(c.className.push("grn"),c.words.push("\u7ed3\u8d34"));!_.isUndefined(d)&&2==d&&(c.className.push("grn"),c.words.push("\u6295\u7968"));b.push(c)}return b},_processToplist:function(a){var b=
[],c,d,e,f;for(e=0,f=a.length;e<f;e++){d=a.at(e);c=d.get("userName");if(!c||""==c)c="UC\u7528\u6237"+d.get("uid");b.push({topicId:d.get("topicId"),title:d.get("title"),userName:c,replyCount:d.get("replyCount"),hitCount:d.get("hitCount"),className:["org"],words:["\u7f6e\u9876"]})}return b},_processBoardIndexInfo:function(a){var b=S.SSCT.GetHandler("Collection","BBS"),c;b.reset(a.toplist);c=this._processToplist(b);b.reset(a.topics.list);b.parse({data:a.topics});this.totalPages=b.pageCount;this.subPageCount=
b.subPageCount;b=this._processTopics(b);return{stats:a.stats,toplist:c,topics:b}},setCache:function(a,b,c,d,e){d=d||60;e=e||!1;if(_.isUndefined(c))return!1;return a&&"string"==typeof a&&b&&"string"==typeof b?(_.isUndefined(this.cache[a])&&(this.cache[a]=[]),-1!=this.cache[a].indexOf(b)&&this.removeCache(a,b),ucf.Cache.set(a+b,c,d,e),this.cache[a].push(b),!0):!1},getCache:function(a,b,c){if(a&&"string"==typeof a&&this.cache[a]&&b&&"string"==typeof b&&-1!=this.cache[a].indexOf(b))return _.isUndefined(c)?
(c=ucf.Cache.get(a+b,!1),!_.isUndefined(c)&&!_.isEmpty(c)?c:ucf.Cache.get(a+b,!0)):ucf.Cache.get(a+b,c)},removeCache:function(a,b,c){var d,e,f,g=function(a,b){var c,d;if(b instanceof Array)for(c=0,d=b.length;c<d;c++)ucf.Cache.remove(a+b[c],!1)||ucf.Cache.remove(a+b[c],!0);else"string"==typeof b&&(ucf.Cache.remove(a+b,!1)||ucf.Cache.remove(a+b,!0))};if(a&&"string"==typeof a&&this.cache[a]){d=this.cache[a];if(b&&"string"==typeof b){e=d.indexOf(b);if(-1==e){c=[];for(e=0,f=d.length;e<f;e++)-1!=d[e].indexOf(b)&&
c.push(d[e]);this.cache[a]=_.difference(d,c);g(a,c);return!0}_.isUndefined(c)?g(a,b):ucf.Cache.remove(a+b,c);this.cache[a]=_.without(d,b)}else g(a,this.cache[a]),this.cache[a]=[];return!0}return!1},_getCurUserInfo:function(){S.SSCT.GetHandler("Controller","User").getCurUserInfo({success:$.proxy(function(a){this.curUser=a},this),error:function(){console.error("\u83b7\u53d6\u7528\u6237\u4fe1\u606f\u5931\u8d25")}})}});S.SSCT.Post=Backbone.Controller.extend({curUser:"",topic:null,boardId:0,topicId:0,gameId:null,eventListener:{},initialize:function(){this._getCurUserInfo()},getTopicInfo:function(a,b){this.boardId=a.boardId;this.gameId=a.gameId;this.topicId=a.topicId;var c=a.editing||!1;if(!this.boardId||!this.gameId||!this.topicId)return b&&b.error?b.error.apply(this,["\u53c2\u6570\u9519\u8bef"]):!1;this.topic=this.topic||S.SSCT.GetHandler("Model","Topic");this.topic.gameId=this.gameId;this.topic.fetch({data:{ucid:this.curUser.ucid,
topicid:this.topicId,boardid:this.boardId,editing:c},success:$.proxy(function(a,c){this.topic.set(c.data);b&&b.success&&b.success.apply(this,[{topic:this._processTopicContent(this.topic),curUser:this.curUser}])},this),error:$.proxy(function(a,c){b&&b.error&&b.error.apply(this,[a,c])},this),quiet:!0})},_processTopicContent:function(a){var b=a.clone(),c,d=[],e="",f=-1,g=-1;switch(a.get("topicType")){case 0:c=b.get("content"),700<c.length&&(e=c.substr(0,700),f=e.lastIndexOf("<"),g=e.lastIndexOf(">"),
f>g&&(e=e.substr(0,f)),0<e.length&&d.push(e),d.push(c),b.set("content",d))}c=b.get("createTime");_.isUndefined(c)||(c=new Date(c),c=c.getMonth()+1+"-"+c.getDate()+" "+c.toString().split(" ")[4].slice(0,5),b.set("createTime",c));b.gameId=a.gameId;return b},_cleanContent:function(a){var b=document.createElement("div");b.innerHTML=a;return a=b.textContent||""},getTopic:function(){this.topic=this.topic||S.SSCT.GetHandler("Model","Topic");return!_.isUndefined(this.topic)&&!_.isEmpty(this.topic)?this.topic:
!1},deleteTopicFile:function(a,b){var c={data:a};if(b&&b.success)c.success=b.success;if(b&&b.error)c.error=b.error;this.bbsModel=this.bbsModel||S.SSCT.GetHandler("Model","BBS");this.bbsModel.deleteTopicFile(c)},saveTopic:function(a,b){var c,d;this.bbsController=this.bbsController||S.SSCT.GetHandler("Controller","BBS");this.bbsController.removeCache("Board");this.bbsController.removeCache("Collection","type=all");this.bbsController.removeCache("Collection","type=new");this.bbsController.removeCache("Collection",
"&group="+a.group);if(0<a.fileList.length)for(c=0,d=a.fileList.length;c<d;c++)S.SSCT.GetHandler("Model","BBS").updateTopicFile({data:a.fileList[c],error:b.error});delete a.fileList;this.topic=this.topic||S.SSCT.GetHandler("Model","Topic");this.topic.save(a,b)},deleteTopic:function(a){this.bbsController=this.bbsController||S.SSCT.GetHandler("Controller","BBS");this.bbsController.removeCache("Board");this.bbsController.removeCache("Collection","type=all");this.bbsController.removeCache("Collection",
"type=new");this.bbsController.removeCache("Collection","group="+this.topic.get("group"));this.topic=this.topic||S.SSCT.GetHandler("Model","Topic");this.topic.del(a)},postTopic:function(a,b){var c=this,d,e;if(!a.title||3>a.title.length)e=["\u8bf7\u8f93\u51653\u4e2a\u5b57\u4ee5\u4e0a\u7684\u6807\u9898\uff01","title"];50<a.title.length&&_.isUndefined(e)&&(e=["\u6807\u9898\u5b57\u6570\u8d85\u8fc7\u4e0a\u965050\u4e2a\u5b57\uff0c\u8bf7\u5220\u51cf\u90e8\u5206\u518d\u53d1\u5e03\uff01","title"]);if(!a.content||
10>a.content.length&&_.isUndefined(e))e=["\u8bf7\u8f93\u516510\u4e2a\u5b57\u4ee5\u4e0a\u7684\u5185\u5bb9\uff01","content"];5E3<a.content.length&&_.isUndefined(e)&&(e=["\u5185\u5bb9\u5b57\u6570\u8d85\u8fc7\u4e0a\u96505000\u4e2a\u5b57\uff0c\u8bf7\u5220\u51cf\u90e8\u5206\u518d\u53d1\u5e03\uff01","content"]);if(e&&b&&b.DataError)return b.DataError.apply(this,e),!1;this.topic=this.topic||S.SSCT.GetHandler("Model","Topic");d=this.topic.checkMatch(a.title);(d=!d?this.topic.checkMatch(a.content):d)&&parseInt(d[0])!==
parseInt(a.group)?b.confirm("\u4f60\u53d1\u5e03\u7684\u5185\u5bb9\u4e2d\u5305\u542b"+d[1]+"\u4fe1\u606f\uff0c\u662f\u5426\u5212\u5206\u5230"+d[1]+"\u5206\u7ec4\u4e2d\uff1f",{callBack:function(){a.group=d[0];c.saveTopic(a,b.TopicCallback)},cancel:function(){c.saveTopic(a,b.TopicCallback)}}):this.saveTopic(a,b.TopicCallback)},getReplyList:function(a,b){this.boardId=a.boardId||this.boardId;this.topicId=a.topicId||this.topicId;S.SSCT.GetHandler("Collection","BBS").getReplies({data:{ucid:this.curUser.ucid,
boardid:this.boardId,topicid:this.topicId,page:a.page,count:a.count},success:$.proxy(function(a){b&&b.success&&b.success.apply(this,[{curUser:this.curUser,collection:this._processReplies(this._processTimeStamps(a))}])},this),error:$.proxy(function(){b&&b.error&&b.error.apply(this,["\u52a0\u8f7d\u56de\u590d\u5217\u8868\u9519\u8bef"])},this),quiet:!0})},_processTimeStamps:function(a){var b,c,d,e;for(d=0,e=a.length;d<e;d++)c=a.at(d),b=new Date(c.get("createTime")),b=b.getFullYear()+"-"+(b.getMonth()+
1)+"-"+b.getDate()+" "+b.toString().split(" ")[4].slice(0,5),c.set("createTime",b);return a},_processReplies:function(a){var b;b="";var c,d,e,f;for(e=0,f=a.length;e<f;e++)d=a.at(e),b=d.get("face"),c=d.get("isLock"),!_.isUndefined(rConfig.bbs.faces[b])&&!c?(b=rConfig.bbs.faceDir+rConfig.bbs.faces[b],d.set("face",b)):d.set("face",""),(!d.get("userLevel")||""==d.get("userLevel"))&&d.set("userLevel","0"),(!d.get("userName")||""==d.get("userName"))&&d.set("userName","UC\u7528\u6237"+d.get("uid"));return a},
submitVoting:function(a,b){this.bbsModel=this.bbsModel||S.SSCT.GetHandler("Model","BBS");this.bbsModel.submitVoting({data:{boardid:this.topic.get("boardId"),topicid:this.topic.get("topicId"),itemids:a.items},success:$.proxy(function(a,d){!0==d.data.result?b&&b.success&&b.success.apply(this):b&&b.error&&b.error.apply(this,["\u6295\u7968\u5931\u8d25"])},this),error:$.proxy(function(a,d){b&&b.error&&b.error.apply(this,[d.msg])},this)})},deleteReply:function(a,b){var c={data:a};if(b&&b.success)c.success=
b.success;if(b&&b.error)c.error=b.error;this.bbsModel=this.bbsModel||S.SSCT.GetHandler("Model","BBS");this.bbsModel.deleteReply(c)},postReply:function(a,b){var c;if(!a.content||!a.content.replace(/\s+/,""))return b&&b.DataError&&b.DataError.apply(this,["\u56de\u590d\u5185\u5bb9\u4e0d\u80fd\u4e3a\u7a7a\uff01"]),!1;if(5E3<a.content.length)return b&&b.DataError&&b.DataError.apply(this,["\u5185\u5bb9\u5b57\u6570\u8d85\u8fc7\u4e0a\u96505000\u4e2a\u5b57\uff0c\u8bf7\u5220\u51cf\u90e8\u5206\u518d\u53d1\u5e03\uff01"]),
!1;c={data:a};if(b.success)c.success=b.success;if(b.ReplyError)c.error=b.ReplyError;this.bbsModel=this.bbsModel||S.SSCT.GetHandler("Model","BBS");this.bbsModel.createReply(c)},_getCurUserInfo:function(){S.SSCT.GetHandler("Controller","User").getCurUserInfo({success:$.proxy(function(a){this.curUser=a},this),error:function(){console.error("\u83b7\u53d6\u7528\u6237\u4fe1\u606f\u5931\u8d25")}})}});S.SSMO.BBS=Backbone.Model.extend({boardId:null,initialize:function(){this.API={GetBoard:eConfig.bbsServerUrl+"/"+rConfig.apis.BBS_GET_BOARD_BY_GAME,GetBoardIndexInfo:eConfig.bbsServerUrl+"/"+rConfig.apis.BBS_GET_BOARD_INDEX_INFO,Vote:S.sdkBase.servType.SDKSERVER+"/"+S.sdkBase.actions.CALL_SDK_SERVER+"/"+rConfig.apis.BBS_VOTE,CreateReply:S.sdkBase.servType.SDKSERVER+"/"+S.sdkBase.actions.CALL_SDK_SERVER+"/"+rConfig.apis.BBS_CREATE_REPLY,DeleteReply:S.sdkBase.servType.SDKSERVER+"/"+S.sdkBase.actions.CALL_SDK_SERVER+
"/"+rConfig.apis.BBS_DELETE_REPLY,DeleteFile:S.sdkBase.servType.SDKSERVER+"/"+S.sdkBase.actions.CALL_SDK_SERVER+"/"+rConfig.apis.BBS_DELETE_FILE,UpdateFile:S.sdkBase.servType.SDKSERVER+"/"+S.sdkBase.actions.CALL_SDK_SERVER+"/"+rConfig.apis.BBS_UPDATE_FILE};this.url=this.API.GetBoard},getBoard:function(){this.url=this.API.GetBoard;this.clear();this.fetch.apply(this,arguments)},getBoardIndexInfo:function(){this.url=this.API.GetBoardIndexInfo;this.clear();this.fetch.apply(this,arguments)},submitVoting:function(){this.url=
this.API.Vote;this.clear();this.fetch.apply(this,arguments)},createReply:function(){this.url=this.API.CreateReply;this.clear();this.fetch.apply(this,arguments)},deleteReply:function(){this.url=this.API.DeleteReply;this.clear();this.fetch.apply(this,arguments)},deleteTopicFile:function(){var a=this.clone();a.clear();a.url=this.API.DeleteFile;this.fetch.apply(a,arguments)},updateTopicFile:function(){var a=this.clone();a.clear();a.url=this.API.UpdateFile;this.fetch.apply(a,arguments)},parse:function(a){if(!_.isUndefined(a)&&
!_.isEmpty(a))return a.data}});S.SSMO.Topic=Backbone.Model.extend({matchConfig:{3:"\u6c42\u52a9,\u6c42,\u600e\u4e48,\u600e\u6837,\u95ee,\u4ec0\u4e48,\u6c42\u6559".split(","),1:"\u653b\u7565,\u653b\u7565,\u770b\u6cd5,\u7bc7,\u6280\u5de7,\u65b9\u6cd5,\u6559\u4f60".split(","),2:["\u8bc4\u6d4b","\u8bc4\u6d4b"]},initialize:function(){_.bindAll(this);this.API={GetTopic:eConfig.bbsServerUrl+"/"+rConfig.apis.BBS_GET_TOPIC,CreateTopic:S.sdkBase.servType.SDKSERVER+"/"+S.sdkBase.actions.CALL_SDK_SERVER+"/"+rConfig.apis.BBS_CREATE_TOPIC,UpdateTopic:S.sdkBase.servType.SDKSERVER+
"/"+S.sdkBase.actions.CALL_SDK_SERVER+"/"+rConfig.apis.BBS_UPDATE_TOPIC,DeleteTopic:S.sdkBase.servType.SDKSERVER+"/"+S.sdkBase.actions.CALL_SDK_SERVER+"/"+rConfig.apis.BBS_DELETE_TOPIC};this.url=this.API.GetTopic},checkMatch:function(a){var b,c,d;if(a&&""!=a)for(d in this.matchConfig)for(b=1,c=this.matchConfig[d].length;b<c;b++)if(-1!=a.indexOf(this.matchConfig[d][b]))return[d,this.matchConfig[d][0]];return!1},fetch:function(){this.url=this.API.GetTopic;this.clear();Backbone.Model.prototype.fetch.apply(this,
arguments)},save:function(a,b){var c=this.clone(),d;(0==a.group||"0"==a.group)&&delete a.group;a.isAdd?(delete a.isAdd,c.url=this.API.CreateTopic):(a.topicid=this.get("topicId"),delete a.isAdd,c.url=this.API.UpdateTopic);d={data:a};if(b.success)d.success=b.success;if(b.error)d.error=b.error;c.clear();Backbone.Model.prototype.fetch.call(c,d)},del:function(a){var a=a||{},b=this.clone(),c={data:{boardid:this.get("boardId"),topicid:this.get("topicId")}};if(a.success)c.success=a.success;if(a.error)c.error=
a.error;b.url=this.API.DeleteTopic;b.clear();Backbone.Model.prototype.fetch.call(b,c)},parse:function(a){if(!_.isUndefined(a)&&!_.isEmpty(a)){if(!a.data.userName||""==a.data.userName)a.data.userName="UC\u7528\u6237"+a.data.uid;if(!a.data.userLevel||""==a.data.userLevel)a.data.userLevel="0";return a.data}}});S.SSVW.BBS=Backbone.View.extend({el:"#bbs",events:{"click .bbsList":"showDetail","click #makeNewPost":"makeNewPost","click #pagePre":"pagePre","click #pageNext":"pageNext","click #pageFirst":"pageFirst","click #pageLast":"pageLast","click #pageNum":"goToPage","click #searchBtn":"showSearch","onclick #keyWord":"flushInpt","click #newPostsNum":"gotoNewPosts","click #askPostsNum":"gotoAskPosts","click #openSearchBtn":"searchOpen","change #game_page_num":"onPageChanged","onclick #game_page_num":"onEditPage",
"click #gameExpBtn":"gotoGameExp","click .nav_five > a":"onChooseTab","click #morePage":"onMorePageBtnClicked","click .nav_five_right":"onMoreTabBtnClicked","click .sn_con > a":"onMoreTabListItemClicked"},currentPage:{},subPage:{},subPageCount:{},searchPage:1,isEditingPage:!1,isSearch:!1,currentTab:"all",currentTabPage:1,totalTabPages:2,perTabNum:4,perTabSize:70,curPerTabSize:70,totalTabs:4,lastTabItem:"test",tab2Index:{all:0,good:1,exp:2,test:3,ask:3,mood:3,advise:3,"new":3},curTabIndex:0,canLoad:!0,
loadingEl:[],topTopics:[],listPageTotal:{},searchPageTotal:null,isSearchOpen:!1,initialize:function(){_.bindAll(this);this.bbsController=S.SSCT.GetHandler("Controller","BBS");this.gameController=S.SSCT.GetHandler("Controller","Game");this.totalPages={all:null,good:null,exp:null,test:null,ask:null,mood:null,advise:null,"new":null};this.gameController.getGameInfo(this.gameController.callBackMix($.proxy(function(){this.bbsController.gameId=this.gameController.gameId},this)))},index:function(a,b){this._initPage(this.currentTab,
b||"1");this._showLoading();this._initBack();var c=this,d=rConfig.bbs.listSubPage,e=this.subPage[this.currentTab]%rConfig.bbs.subPageCount,b=this.subPage[this.currentTab];if("all"===this.currentTab&&1===this.currentPage[this.currentTab]){if(1!==e)switch(e){case 0:d=rConfig.bbs.listPerIndexPage;b=this.currentPage[this.currentTab];break;case 2:this.subPage[this.currentTab]--,b=this.subPage[this.currentTab]}this.bbsController.getBoardIndexInfo({page:b,count:d},{success:function(a){c.renderBoard(a.stats);
c.renderTopics(a.topics,"replace");c.renderToplist(a.toplist);c.listPageTotal[c.currentTab]=c.bbsController.totalPages;c.subPageCount[c.currentTab]=c.bbsController.subPageCount;c.renderPaginate();c._hideLoading();c.canLoad=!0;if(2===e)c.onMorePageBtnClicked()},error:function(){c.renderErrorPage();c._hideLoading()}})}else this.bbsController.getBoardInfo({},this.bbsController.callBackMix(function(a){c.renderBoard(a);c.renderBBS()},function(a){sdk.common.ui.NoticeBox.error(a);c._hideLoading()}));this.showTabs();
$(window).bind("resize",_.bind(this._resize,this))},renderBoard:function(a){$(".boardNameContainer").html(a.boardName);$("#askPostsNum>em").html(a.helpTopicCount);$("#newPostsNum>em").html(a.dailyTopicCount);var b=$("#newPostsNum").css("width"),c=$("#askPostsNum").css("width"),b=b>c?b:c;$("#askPostsNum").css("width",b);$("#newPostsNum").css("width",b);10>a.dailyTopicCount&&$(".n_ico").css("left","28px")},renderTopics:function(a,b){var b=b||"append",c=template("list_template",{listBoardTopics:a});
$("#postsContent-"+this.currentTab)[{append:"append",replace:"html"}[b]](c)},renderToplist:function(a){a=template("list_template",{listBoardTopics:a,id:"topTopicList"});$("#postsContent-"+this.currentTab).prepend(a)},renderErrorPage:function(){$("#paginate").css("display","none");var a=template("error_templ",{});$("#postsContent-"+this.currentTab).html(a)},renderBBS:function(){this.isSearch=!1;if(!1===this.canLoad)return sdk.common.ui.NoticeBox.error("\u60a8\u7684\u64cd\u4f5c\u592a\u5feb\u4e86\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5");
this.canLoad=!1;this._showLoading();var a=this,b,c,d;d=rConfig.bbs.listSubPage;c=this.subPage[this.currentTab];if(1!=this.subPage[this.currentTab]%rConfig.bbs.subPageCount)switch(b=this.subPage[this.currentTab]%rConfig.bbs.subPageCount,b){case 0:d=rConfig.bbs.listPerIndexPage;c=this.currentPage[this.currentTab];break;case 2:this.subPage[this.currentTab]--,c=this.subPage[this.currentTab]}this.updateLastTabItem(this.lastTabItem);this.bbsController.getListData(this.currentTab,c,d,this.bbsController.callBackMix(function(c){a.listPageTotal[a.currentTab]=
a.bbsController.totalPages;a.subPageCount[a.currentTab]=a.bbsController.subPageCount;a.renderTopics(c,"replace");a.renderPaginate();"all"==a.currentTab&&1==a.currentPage[a.currentTab]?a.bbsController.getTopicData(a.bbsController.callBackMix(function(b){a.renderToplist(b);a._hideLoading();a.canLoad=!0},function(){a._hideLoading();a.canLoad=!0})):(a._hideLoading(),a.canLoad=!0);if(2==b)a.canLoad=!0,a.onMorePageBtnClicked()},function(){a.renderErrorPage();a._hideLoading();a.canLoad=!0}))},renderPaginate:function(){var a=
"more",b;if(0==this.subPage[this.currentTab]%rConfig.bbs.subPageCount||this.currentPage[this.currentTab]==this.listPageTotal[this.currentTab]&&this.subPage[this.currentTab]==this.subPageCount[this.currentTab])a="paging";else if(0==this.subPageCount[this.currentTab]){$("#paginate").html("");return}b=template("pagecontrol_templ",{type:a});$("#paginate").html(b);"paging"==a&&this.handlePaginate();$("#paginate").show()},handlePaginate:function(){var a=this.isSearch?this.searchPage:this.currentPage[this.currentTab],
b=this.isSearch?this.searchPageTotal:this.listPageTotal[this.currentTab];1==a?$("#pagePre").addClass("font_gray"):$("#pagePre").removeClass("font_gray");a==b?$("#pageNext").addClass("font_gray"):$("#pageNext").removeClass("font_gray");0==b?$("#paginate").css("display","none"):$("#paginate").css("display","block");$("#game_page_num").val(a+"/"+b);this.isSearch&&$("#searchPostsNum").html(this.bbsController.totalNum)},showSearch:function(){sdk.Log.click(S.Log.businesses.PAGE_BBS,["topSearchBtn"]);this.searchPage=
1;var a=$.trim($("#keyWord").val());if(_.isEmpty(a))return sdk.common.ui.NoticeBox.error("\u8bf7\u8f93\u5165\u641c\u7d22\u5173\u952e\u5b57!"),!1;a=a.replace(/(<([^>]+)>)/ig,"");if(""==a)return sdk.common.ui.NoticeBox.error("\u60a8\u641c\u7d22\u7684\u5173\u952e\u5b57\u542b\u6709\u975e\u6cd5\u5b57\u7b26\uff0c\u8bf7\u91cd\u65b0\u8f93\u5165!"),!1;$(document).off("click");sdk.Url.location.route("#!bbs/search/"+this.searchPage+"/"+encodeURIComponent(a))},search:function(a,b){S.SCEV.Proxy.trigger(S.SCEV.EventType.PRE_ROUTE,
{enterPage:sdk.Log.businesses.PAGE_BBS,enterBusiness:["search"]});this.isSearch=!0;var c=this,d=function(){$(".boardNameContainer").html(c.boardName);c.bbsController.getSearchData(b,a,rConfig.bbs.listPerPage,c.bbsController.callBackMix(function(a){c.searchPageTotal=c.bbsController.totalPages;a=template("list_template",{listBoardTopics:a});$("#postsContainer_search").html(a);c.canLoad=!0;c.handlePaginate();c._hideLoading()},function(){$("#paginate").css("display","none");var a=template("error_templ",
{});$("#postsContainer_search").html(a);$("#searchPostsNum").html("0");c._hideLoading();c.canLoad=!0}))};this._showLoading();this.boardName?(this._renderNum(),d()):this.bbsController.getBoardInfo({},this.bbsController.callBackMix(function(a){c.boardName=a.boardName;c.askPostsNum=a.helpTopicCount;c.newPostsNum=a.dailyTopicCount;c._renderNum();d()},function(a){sdk.common.ui.NoticeBox.error(a);c._hideLoading()}))},showDetail:function(a,b){if(!0==this.isSearchOpen)return this._hideSearch(),!1;if(this.isEditingPage)this.isEditingPage=
!1;else{var c=b.getAttribute("data-topicId");sdk.Url.location.route("#!post/detail/"+this.bbsController.boardId+"/"+this.bbsController.gameId+"/"+c)}},showFooter:function(){this.$el.append(template("bbsFooter_templ",{}))},makeNewPost:function(){if(!0==this.isSearchOpen)return this._hideSearch(),!1;sdk.Url.location.route("#!topic/edit/"+this.bbsController.boardId+"/"+this.bbsController.gameId)},fakeRoute:function(a){$("#paginate").hide();window.scrollTo(0,0);var b=a.split("/"),a=b[2],b=b[3],c=$("#postsContent-"+
a).children(),d=this.currentTab;this.currentTab=a;_.isUndefined(this.currentPage[a])&&(this.subPage[a]=1,this.currentPage[a]=1,this.subPageCount[a]=1);if(this.subPage[a]<this.currentPage[a]*rConfig.bbs.subPageCount-2||this.subPage[a]>this.currentPage[a]*rConfig.bbs.subPageCount)c=[];this._initPage(a,b);this.updateLastTabItem(this.lastTabItem);0!=c.length&&d!=a&&$("#postsContent-"+a+">ul>li")[0]&&"no-content"!=$("#postsContent-"+a+">ul>li")[0].id?($("#postsContent-"+a).show(),this.renderPaginate(),
$("#postsContent-"+d).hide()):(this.renderBBS(),$("#postsContent-"+a).show(),d!=a&&$("#postsContent-"+d).hide());this.showTabs()},pagePre:function(){if(!0==this.isSearchOpen)return this._hideSearch(),!1;if(this.isSearch){if(1!=this.searchPage){var a=window.location.href.split("/"),a=a[a.length-1];this.searchPage--;sdk.Url.location.route("#!bbs/search/"+this.searchPage+"/"+a)}}else 1!=this.currentPage[this.currentTab]&&(this.currentPage[this.currentTab]--,sdk.Url.location.route("#!bbs/index/"+this.currentTab+
"/"+this.currentPage[this.currentTab]))},pageNext:function(){if(!0==this.isSearchOpen)return this._hideSearch(),!1;var a;if((this.isSearch?this.searchPage:this.currentPage[this.currentTab])!=(this.isSearch?this.searchPageTotal:this.listPageTotal[this.currentTab]))this.isSearch?(a=window.location.href.split("/"),a=a[a.length-1],this.searchPage++,sdk.Url.location.route("#!bbs/search/"+this.searchPage+"/"+a)):(this.currentPage[this.currentTab]++,sdk.Url.location.route("#!bbs/index/"+this.currentTab+
"/"+this.currentPage[this.currentTab]))},pageFirst:function(){if(!0==this.isSearchOpen)return this._hideSearch(),!1;if(this.isSearch){if(1!=this.searchPage){this.searchPage=1;var a=window.location.href.split("/");sdk.Url.location.route("#!bbs/search/"+this.searchPage+"/"+a[a.length-1])}}else 1!=this.currentPage[this.currentTab]&&(this.currentPage[this.currentTab]=1,sdk.Url.location.route("#!bbs/index/"+this.currentTab+"/"+this.currentPage[this.currentTab]))},pageLast:function(){if(!0==this.isSearchOpen)return this._hideSearch(),
!1;var a,b;if(this.isSearch){if(a=this.searchPageTotal,this.searchPage!=a)this.searchPage=a,b=window.location.href.split("/"),b=b[b.length-1],sdk.Url.location.route("#!bbs/search/"+a+"/"+b)}else a=this.listPageTotal[this.currentTab],this.currentPage[this.currentTab]!=a&&(this.currentPage[this.currentTab]=a,sdk.Url.location.route("#!bbs/index/"+this.currentTab+"/"+this.currentPage[this.currentTab]))},onEditPage:function(){!0==this.isSearchOpen&&this._hideSearch();$("#game_page_num").val("");this.isEditingPage=
!0},onPageChanged:function(){var a=$("#game_page_num").val(),b=$("#game_page_num").val().match(/([0-9]+)/),c=this.isSearch?this.searchPageTotal:this.listPageTotal[this.currentTab],d=this.isSearch?this.searchPage:this.currentPage[this.currentTab];if(""==a)$("#game_page_num").val(d+"/"+c);else if(null==b||b[0].length!=a.length)$("#game_page_num").val(d+"/"+c);else{if(1>=a)a=1;else if(a>c)a=c;else if(a==d)return $("#game_page_num").val(a+"/"+c),!1;$("#game_page_num").val(a+"/"+c);this.isSearch?(b=window.location.href.split("/"),
b=b[b.length-1],sdk.Url.location.route("#!bbs/search/"+a+"/"+b)):sdk.Url.location.route("#!bbs/index/"+this.currentTab+"/"+a)}},onMorePageBtnClicked:function(){!0==this.isSearchOpen&&this._hideSearch();if(!1===this.canLoad)return sdk.common.ui.NoticeBox.error("\u60a8\u7684\u64cd\u4f5c\u592a\u5feb\u4e86\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5");this.canLoad=!1;var a=this;this._showLoading();this.bbsController.getListData(this.currentTab,this.subPage[this.currentTab]+1,rConfig.bbs.listSubPage,this.bbsController.callBackMix(function(b){a.listPageTotal[a.currentTab]=
a.bbsController.totalPages;a.renderTopics(b);a.subPage[a.currentTab]++;a.renderPaginate();a._hideLoading();a.canLoad=!0},function(){sdk.common.ui.NoticeBox.error("\u52a0\u8f7d\u6570\u636e\u9519\u8bef\uff0c\u8bf7\u7a0d\u540e\u91cd\u8bd5\u3002");a.canLoad=!0;a._hideLoading()}))},goToPage:function(a,b){var c=b.getAttribute("data-pageId");sdk.Url.location.route("#!bbs/index/"+c)},showTabs:function(){var a;this.suitTab();for(a=1;a<=this.totalTabPages;a++)if(this.tab2Index[this.currentTab]<this.perTabNum*
a&&this.tab2Index[this.currentTab]>=this.perTabNum*(a-1))this.currentTabPage=a;this.slideUnderLineTo(this.tab2Index[this.currentTab],!0)},slideUnderLineTo:function(a,b){b=!_.isUndefined(b)?b:!1;if(a!=this.curTabIndex||b){this.curTabIndex=a;var c=0,c=a<this.perTabNum*this.currentTabPage&&a>=this.perTabNum*(this.currentTabPage-1)?a%this.perTabNum*this.curPerTabSize:a>this.perTabNum*this.currentTabPage?this.curPerTabSize+$(window).width():-this.curPerTabSize;$("#nav_line").css({"-webkit-transform":"translate("+
c+"px, 0px)","-webkit-transition-duration":"0s",left:"0px"})}},suitTab:function(){var a=0,b=0;$(window).width();this.perTabNum=this.totalTabs;a=Math.floor(($(window).width()-30)/this.totalTabs);b=$(window).width()-this.totalTabs*a;this.curPerTabSize=a;$("#postsContainer > a").each(function(){$(this).css({width:a})});this.totalTabPages=this.currentTabPage=1;$("#nav_line").width(a);$("#js_lis").width(b)},onChooseTab:function(a,b){if(!0==this.isSearchOpen)return this._hideSearch(),!1;var c=$(b).attr("id").replace("Posts",
""),d=this;this.slideUnderLineTo(this.tab2Index[c]);_.delay(function(){d.fakeRoute("#!bbs/index/"+c+"/"+d.currentPage[c])},100)},onMoreTabBtnClicked:function(){if(!0==this.isSearchOpen)return this._hideSearch(),!1;var a=$("#js-po");"none"==a.css("display")&&(a.css("display","block"),sdk.common.ui.Mask.show({opacity:0.3}),_.delay(function(){$(document).on("click",function(){"block"==a.css("display")&&(a.css("display","none"),sdk.common.ui.Mask.remove());$(document).off("click")})},500))},onMoreTabListItemClicked:function(a,
b){var c=$(b).attr("id").replace("Posts",""),d=this;this.lastTabItem=c;this.slideUnderLineTo(this.tab2Index[c]);_.delay(function(){d.fakeRoute("#!bbs/index/"+c+"/"+d.currentPage[c])},100)},updateLastTabItem:function(a){if(!a||""==a||2>=this.tab2Index[a])return!1;var a=$("#"+a+"Posts").remove(),b=$(".last-none").remove();b.removeClass("last-none");a.css("width",this.curPerTabSize);a.insertBefore("#js_lis");a.addClass("last-none");b.removeAttr("style");$(".sn_con").append(b)},gotoAskPosts:function(){if(!0==
this.isSearchOpen)return this._hideSearch(),!1;sdk.Log.click(S.Log.businesses.PAGE_BBS,["topAskPost"]);if("ask"==this.currentTab)return!1;this.lastTabItem="ask";this.fakeRoute("#!bbs/index/ask/1")},gotoNewPosts:function(){if(!0==this.isSearchOpen)return this._hideSearch(),!1;sdk.Log.click(S.Log.businesses.PAGE_BBS,["topNewPost"]);if("new"==this.currentTab)return!1;this.lastTabItem="new";this.fakeRoute("#!bbs/index/new/1")},gotoGameExp:function(){if(!0==this.isSearchOpen)return this._hideSearch(),
!1;sdk.Log.click(S.Log.businesses.PAGE_BBS,["gameExp"]);S.Url.redirect(eConfig.gameExpUrl)},searchOpen:function(){var a=$("#gr_search_win"),b=this;if("none"==a.css("display"))this.isSearchOpen=!0,$("#icon_umbrella").off("click"),a.slideDown(10),$("#openSearchBtn").removeClass("n_seach"),$("#openSearchBtn").addClass("n_spar"),_.delay(function(){$(document).on("click",function(a){if("searchBtn"==a.target.id||"gr_search_win"==a.target.id||"bodyMask"==a.target.id||"gr_search_win"==a.target.parentNode.id)return a;
$("#openSearchBtn").hasClass("n_spar")&&b._hideSearch();$(document).off("click")})},500)},flushInpt:function(a){_.isEmpty($(a.target).val())&&($(a.target).val(""),a.stopPropagation())},_hideSearch:function(){this.isSearchOpen=!1;$("#gr_search_win").slideUp(10);$("#openSearchBtn").removeClass("n_spar");$("#openSearchBtn").addClass("n_seach");$(document).off("click");$("#icon_umbrella").on("click",sdk.common.ui.Umbrella.toggle)},_showUmbrella:function(){1>$("#icon_umbrella").length&&(this.$el.append(template("umbrella_templ",
{})),sdk.common.ui.Umbrella.init("post"))},_showLoading:function(){_.isEmpty(this.loadingEl)&&this.loadingEl.push(S.common.ui.NoticeBox.loading())},_hideLoading:function(){var a,b;for(a=0,b=this.loadingEl.length;a<b;a++)S.common.ui.NoticeBox.hide(this.loadingEl[a],null,"remove");this.loadingEl=[]},_initPage:function(a,b){this.currentTab=!_.isUndefined(a)&&_.isString(a)?a:"all";b=!_.isUndefined(b)&&b.match(/[0-9]+/)?parseInt(b):!_.isUndefined(a)&&a.match(/[0-9]+/)?parseInt(a):1;this.currentPage[this.currentTab]=
b;this.subPage[this.currentTab]=this.subPage[this.currentTab]||1;a=this.currentTab;if(this.subPage[a]<this.currentPage[a]*rConfig.bbs.subPageCount-2||this.subPage[a]>this.currentPage[a]*rConfig.bbs.subPageCount){var c=this.currentPage[a]*rConfig.bbs.subPageCount-2;this.subPage[a]=c>this.subPageCount[a]?this.subPageCount[a]:c}S.SCEV.Proxy.trigger(S.SCEV.EventType.PRE_ROUTE,{enterPage:sdk.Log.businesses.PAGE_BBS,enterBusiness:["index",a,b]});this._showUmbrella();this.isSearchOpen=!1},_initBack:function(){$(document).on("bridgebackhistory",
function(a){0<=a.historyToBack.indexOf("user.html")&&sdk.SdkHeader.show("UC\u6e38\u620f")})},_resize:function(){this.showTabs()},_renderNum:function(){$("#askPostsNum>em").html(this.askPostsNum);$("#newPostsNum>em").html(this.newPostsNum);var a=$("#newPostsNum").css("width"),b=$("#askPostsNum").css("width"),a=a>b?a:b;$("#askPostsNum").css("width",a);$("#newPostsNum").css("width",a);10>this.newPostsNum&&$(".n_ico").css("left","28px")}});S.SSVW.Post=Backbone.View.extend({el:"#bbs",topic:null,numOfReplyPage:1,curPage:1,viewMode:"detail",loadingEl:{},boardId:0,topicId:0,gameId:0,isClosed:!1,events:{"click #show_more_post_btn":"onShowAllBtnClicked","click #vote_btn":"onVoteButtonClicked","click #page_Pre,#page_Next":"onPageButtonClicked","click #makeNewReply":"makeNewReply","click .extraContent":"onExtraContentClicked","click #show_all_content_btn":"onShowAllContentClicked","click #first_page":"onFistPageBtnClicked","click #last_page":"onLastPageBtnClicked",
"change #result_page_num":"onPageChanged","onclick #result_page_num":"onEditPage","click #gameExpBtn":"gotoGameExp","click .deleteReplyBtn":"deleteReply","click .deleteTopicBtn":"deleteTopic"},initialize:function(){_.bindAll(this)},showUmbrella:function(){1>$("#icon_umbrella").length&&(this.$el.append(template("umbrella_templ",{})),sdk.common.ui.Umbrella.init("reply"))},makeNewReply:function(){!0!=this.isClosed&&sdk.Url.location.route("#!reply/edit/"+this.boardId+"/"+this.gameId+"/"+this.topicId+
"/"+this.viewMode)},deleteTopic:function(){sdk.Log.click(S.Log.businesses.PAGE_BBS,["deleteTopic",this.boardId,this.topicId]);sdk.common.ui.MsgBox.confirm("\u786e\u5b9a\u5220\u9664\u8be5\u5e16\u5b50\uff1f",{callBack:$.proxy(function(){this.controller.deleteTopic(this.controller.callBackMix(function(){sdk.common.ui.NoticeBox.ok("\u5220\u9664\u5e16\u5b50\u6210\u529f\uff01",function(){S.Url.back()})},function(a,b){var c="";5000201==b.code&&(c="\u5df2\u8d85\u8fc7\u53ef\u5220\u9664\u65f6\u95f4\u9650\u5236\uff0c\u65e0\u6cd5\u8fdb\u884c\u5220\u9664~");
sdk.common.ui.NoticeBox.error(c||"\u5f88\u62b1\u6b49\uff0c\u51fa\u9519\u4e86\uff01")}))},this)});return!1},deleteReply:function(a){var b=a.currentTarget.getAttribute("data-replyId");sdk.Log.click(S.Log.businesses.PAGE_BBS,["deleteReply",this.boardId,this.topicId,b]);sdk.common.ui.MsgBox.confirm("\u786e\u5b9a\u5220\u9664\u8be5\u56de\u590d\uff1f",{callBack:$.proxy(function(){this.controller.deleteReply({boardid:this.boardId,topicid:this.topicId,replyid:b},this.controller.callBackMix($.proxy(function(){$(a.currentTarget).parents(".replyContainer").remove();
this.refreshTopicInfo();this.refreshReplyList();sdk.common.ui.NoticeBox.ok("\u5220\u9664\u56de\u590d\u6210\u529f!")},this),$.proxy(function(a,b){var e="";5000140==b.code&&(e="\u5df2\u8d85\u8fc78\u5c0f\u65f6\u53ef\u5220\u9664\u65f6\u95f4\u9650\uff0c\u65e0\u6cd5\u8fdb\u884c\u5220\u9664~");sdk.common.ui.NoticeBox.error(e||"\u5f88\u62b1\u6b49\uff0c\u51fa\u9519\u4e86\uff01")},this)))},this)})},initView:function(a){this.controller=this.controller||S.SSCT.GetHandler("Controller","Post");this.viewMode=a;
this.isClosed=!1;this.showUmbrella()},detail:function(a,b,c){S.SCEV.Proxy.trigger(S.SCEV.EventType.PRE_ROUTE,{enterPage:sdk.Log.businesses.PAGE_BBS,enterBusiness:["postDetailView",c,a,b]});this.initView("detail");this.numOfReplyPage=this.curPage=1;this.boardId=a;this.gameId=b;this.topicId=c;this._showLoading();S.SSCT.GetHandler("Controller","BBS").getBoardInfo({gameId:b},this.controller.callBackMix($.proxy(function(d){this.renderBoardInfo(d);this.controller.getTopicInfo({boardId:a,gameId:b,topicId:c},
this.controller.callBackMix($.proxy(function(b){this.isClosed=b.topic.get("isClosed");this.renderTopicInfo(b);this.controller.getReplyList({boardId:a,topicId:c,page:1,count:rConfig.bbs.topicReplyCount},this.controller.callBackMix($.proxy(function(a){this.renderReplyList(a);this._hideLoading()},this),$.proxy(function(a){this.onError(a);this._hideLoading()},this)))},this),$.proxy(function(a,b){this.onTopicError(a,b);this._hideLoading()},this)))},this),this.onError))},allReplies:function(a,b,c,d){S.SCEV.Proxy.trigger(S.SCEV.EventType.PRE_ROUTE,
{enterPage:sdk.Log.businesses.PAGE_BBS,enterBusiness:["showAllReplies",c,a,b,d]});this.initView("reply");this.curPage=d||1;this.numOfReplyPage=1;this.boardId=a;this.gameId=b;this.topicId=c;this._showLoading();S.SSCT.GetHandler("Controller","BBS").getBoardInfo({gameId:b},this.controller.callBackMix($.proxy(function(d){_.isNull(this.topic)&&this.controller.getTopicInfo({boardId:a,gameId:b,topicId:c},this.controller.callBackMix($.proxy(function(a){this.isClosed=a.topic.get("isClosed");!0==this.isClosed&&
$("#makeNewReply").addClass("disable")},this),this.onTopicError));this.renderBoardInfo(d);this.controller.getReplyList({boardId:a,topicId:c,page:this.curPage,count:rConfig.bbs.listPerPage},this.controller.callBackMix($.proxy(function(a){this.renderReplyList(a);this._hideLoading()},this),$.proxy(function(a){this.onError(a);this._hideLoading()},this)));$(".topicInfoHref").attr("href","#!post/detail/"+a+"/"+b+"/"+c)},this),this.onError))},renderBoardInfo:function(a){$(".boardNameContainer").html(a.boardName)},
renderTopicInfo:function(a){$("#topicTitle").html(a.topic.get("title"));this.topic=a.topic;var b=template("topicInfo_templ",{topic:a.topic,user:a.curUser});$("#topicInfo").html(b);0==a.topic.get("topicType")&&"string"!=typeof a.topic.get("content")?$("#topicContent1").hide():$("#content_paging").hide();!0==this.isClosed&&$("#makeNewReply").addClass("disable")},renderReplyList:function(a){var b;this.numOfReplyPage=Math.ceil(a.collection.totalCount/("detail"==this.viewMode?rConfig.bbs.topicReplyCount:
rConfig.bbs.listPerPage));b=template("replyList_templ",{viewMode:this.viewMode,replyList:a.collection,replyPage:this.numOfReplyPage,topicId:this.topicId,boardId:this.boardId,user:a.curUser,isClosed:this.isClosed});$("#replyList").html(b);"detail"==this.viewMode&&$(".fullReplyContent").hide();b=a.collection.at(0);"detail"==this.viewMode&&b&&b.get("uid")==a.curUser.ucid&&24E4>(new Date).getTime()-(new Date(b.get("createTime"))).getTime()&&window.scrollTo(0,$(".replyContainer")[0].offsetTop-window.innerHeight/
2+100);this.addReplyListPaging()},addReplyListPaging:function(){"detail"==this.viewMode?($(".game_page").hide(),1>=this.numOfReplyPage&&$(".ui-more-btn").hide()):"reply"==this.viewMode&&($(".ui-more-btn").hide(),$("#result_page_num").val(this.curPage+"/"+this.numOfReplyPage),1==this.numOfReplyPage||0==this.numOfReplyPage?$(".game_page").hide():(1==this.curPage?$("#page_Pre").addClass("font_gray"):$("#page_Pre").removeClass("font_gray"),this.curPage==this.numOfReplyPage?$("#page_Next").addClass("font_gray"):
$("#page_Next").removeClass("font_gray")))},refreshReplyList:function(){var a={detail:rConfig.bbs.topicReplyCount,reply:rConfig.bbs.listPerPage};this._showLoading();this.controller.getReplyList({boardId:this.boardId,topicId:this.topicId,page:this.curPage,count:a[this.viewMode]},this.controller.callBackMix($.proxy(function(a){this.renderReplyList(a);this._hideLoading()},this),this.onError))},refreshTopicInfo:function(){this._showLoading();this.controller.getTopicInfo({boardId:this.boardId,gameId:this.gameId,
topicId:this.topicId},this.controller.callBackMix($.proxy(function(a){this.renderTopicInfo(a);this._hideLoading()},this),this.onTopicError))},onShowAllBtnClicked:function(){0!=this.numOfReplyPage&&sdk.Url.location.route("#!post/allReplies/"+this.boardId+"/"+this.gameId+"/"+this.topicId+"/"+this.curPage)},onPageButtonClicked:function(a){a=a.currentTarget.getAttribute("id");"page_Next"==a?this.curPage<this.numOfReplyPage&&(this.curPage++,sdk.Url.location.route("#!post/allReplies/"+this.boardId+"/"+
this.gameId+"/"+this.topicId+"/"+this.curPage)):"page_Pre"==a&&1<this.curPage&&(this.curPage--,sdk.Url.location.route("#!post/allReplies/"+this.boardId+"/"+this.gameId+"/"+this.topicId+"/"+this.curPage))},onExtraContentClicked:function(a){a=a.currentTarget.getAttribute("id").substr(5);$("#replyContent"+a).hide();$("#extra"+a).hide();$("#fullReplyContent"+a).show()},onShowAllContentClicked:function(){$("#topicContent").html(this.topic.get("content")[1]);$("#show_all_content_btn").hide()},onFistPageBtnClicked:function(){this.curPage=
1;sdk.Url.location.route("#!post/allReplies/"+this.boardId+"/"+this.gameId+"/"+this.topicId+"/"+this.curPage)},onLastPageBtnClicked:function(){this.curPage=this.numOfReplyPage;sdk.Url.location.route("#!post/allReplies/"+this.boardId+"/"+this.gameId+"/"+this.topicId+"/"+this.curPage)},onEditPage:function(){$("#result_page_num").val("")},onPageChanged:function(){var a=$("#result_page_num").val().match(/[0-9]+/);if(null==a||""==a[0])$("#result_page_num").val(this.curPage+"/"+this.numOfReplyPage);else{a=
a[0];if(1>a)a=1;else if(a>this.numOfReplyPage)a=this.numOfReplyPage;else if(a==parseInt(this.curPage))return $("#result_page_num").val(this.curPage+"/"+this.numOfReplyPage),!1;this.curPage=a;sdk.Url.location.route("#!post/allReplies/"+this.boardId+"/"+this.gameId+"/"+this.topicId+"/"+this.curPage)}},onVoteButtonClicked:function(){var a=this.controller.getTopic().get("voteMax"),b=$(".voteItem"),c=[],d,e;for(d=0,e=b.length;d<e;d++)b[d].checked&&c.push(b[d].id.substr(8));c.length>a?sdk.common.ui.NoticeBox.error("\u6bcf\u4eba\u53ea\u80fd\u6295 "+
a+" \u7968"):this.controller.submitVoting({items:c.toString()},this.controller.callBackMix(this.refreshTopicInfo,this.onError))},onError:function(a){a=a||"\u64cd\u4f5c\u51fa\u9519";a=_.isString(a)?a:"\u64cd\u4f5c\u51fa\u9519";sdk.common.ui.NoticeBox.error(a);this._hideLoading()},onTopicError:function(a,b){var c={5000201:"\u5df2\u8d85\u8fc7\u53ef\u5220\u9664\u65f6\u95f4\u9650\u5236\uff0c\u65e0\u6cd5\u8fdb\u884c\u5220\u9664~",5001001:"\u5df2\u8d85\u8fc7\u53ef\u7f16\u8f91\u65f6\u95f4\u9650\u5236\uff0c\u65e0\u6cd5\u8fdb\u884c\u7f16\u8f91~\uff01",
5000200:"\u4f60\u7684\u64cd\u4f5c\u592a\u5feb\u4e86\uff0c\u8bf7\u6b47\u4e00\u4f1a\u5427~",5000020:"\u5f88\u62b1\u6b49\uff0c\u65e0\u6b64\u5e16\u5b50~",5000053:"\u5f88\u62b1\u6b49\uff0c\u4f60\u65e0\u6743\u9650\u8fdb\u884c\u8be5\u64cd\u4f5c~",5000060:"\u5f88\u62b1\u6b49\uff0c\u65e0\u6b64\u6587\u4ef6",5001908:"\u5f88\u62b1\u6b49\uff0c\u60a8\u53d1\u5e03\u7684\u5185\u5bb9\u542b\u6709\u654f\u611f\u4fe1\u606f\uff0c\u53d1\u5e03\u4e0d\u6210\u529f\uff01",408:"\u5f88\u62b1\u6b49\uff0c\u670d\u52a1\u5668\u6ca1\u6709\u53ca\u65f6\u54cd\u5e94",
other:"\u5f88\u62b1\u6b49\uff0c\u51fa\u9519\u4e86\uff01"},d=c[b.code];if(!d&&b.msg&&""!=b.msg)d=b.msg;sdk.common.ui.NoticeBox.error(d||c.other);this._hideLoading()},gotoGameExp:function(){sdk.Log.click(S.Log.businesses.PAGE_BBS,["gameExp"]);S.Url.redirect(eConfig.gameExpUrl)},_showLoading:function(){if(_.isEmpty(this.loadingEl))this.loadingEl=S.common.ui.NoticeBox.loading()},_hideLoading:function(){if(!_.isEmpty(this.loadingEl))S.common.ui.NoticeBox.hide(this.loadingEl,null,"remove"),this.loadingEl=
{}}});S.SSVW.Reply=Backbone.View.extend({el:"#bbs",events:{"submit #postReplyForm":"onPostBtnClicked","click #postReplyFaceBtn":"showOrHideFaces","click #faceContainer>span":"faceSelect"},initialize:function(){_.bindAll(this)},edit:function(a,b,c,d){S.SCEV.Proxy.trigger(S.SCEV.EventType.PRE_ROUTE,{enterPage:sdk.Log.businesses.PAGE_BBS,enterBusiness:["editReply",a,c]});this.controller=this.controller||S.SSCT.GetHandler("Controller","Post");this.topicId=c;this.gameId=b;this.boardId=a;this.backview=d||"detail";
this.renderReply()},renderReply:function(){var a=template("smiley_templ",{faces:rConfig.bbs.faces,faceDir:rConfig.bbs.faceDir});$("#faceContainer").html(a);this.$faceDiv=this.$el.find("#sdkFacePop");this.$faceDiv.isShow=!1;this.downBreadDiv=$("#replyDownBreadDiv");this.$faceImage=this.$el.find("#postReplyFaceBtn > img");this.selectedFace="";this.$el.find("input,textarea").each(function(a,c){if(_.isEmpty($(c).val()))c.onfocus=function(){_.isEmpty($(this).val())&&$(this).val("")},$(c).val("")});$("#content").focus()},
onPostBtnClicked:function(){var a=$("#postReplyForm")[0],b={topicid:this.topicId,boardid:this.boardId,content:$(a.content).val()};if(this.selectedFace&&""!=this.selectedFace)b.face=this.selectedFace;this.controller.postReply(b,{success:$.proxy(function(){this.selectedFace="";var a=this;S.common.ui.NoticeBox.ok("\u56de\u590d\u6210\u529f\uff01",function(){"detail"==a.backview?S.Url.back():sdk.Url.location.route("#!post/allReplies/"+a.boardId+"/"+a.gameId+"/"+a.topicId+"/1")})},this),DataError:$.proxy(function(b){S.common.ui.MsgBox.alert(b,
{callBack:function(){a.content.focus()}})},this),ReplyError:this.onReplyError});return!1},faceSelect:function(a){this.selectedFace=a.currentTarget.getAttribute("data-faceId");this.$faceImage.attr("src",rConfig.bbs.faceDir+rConfig.bbs.faces[this.selectedFace]);this.downBreadDiv.hide();this.showOrHideFaces();setTimeout(this.showDownBreadDiv,500)},showOrHideFaces:function(){this.$faceDiv.isShow?(this.$faceDiv.isShow=!1,this.$faceDiv.addClass("hide")):(this.$faceDiv.isShow=!0,this.$faceDiv.removeClass("hide"));
return!1},showDownBreadDiv:function(){this.downBreadDiv.show()},onError:function(a){sdk.common.ui.NoticeBox.error(a||"\u64cd\u4f5c\u51fa\u9519")},onReplyError:function(a,b){var c={5000140:"\u5df2\u8d85\u8fc7\u53ef\u5220\u9664\u65f6\u95f4\u9650\u5236\uff0c\u65e0\u6cd5\u8fdb\u884c\u5220\u9664~",5001E3:"\u4f60\u7684\u64cd\u4f5c\u592a\u5feb\u4e86\uff0c\u8bf7\u6b47\u4e00\u4f1a\u5427~",5000020:"\u5f88\u62b1\u6b49\uff0c\u65e0\u6b64\u5e16\u5b50~",5000023:"\u5f88\u62b1\u6b49\uff0c\u65e0\u6b64\u56de\u590d~",
5000053:"\u5f88\u62b1\u6b49\uff0c\u4f60\u65e0\u6743\u9650\u8fdb\u884c\u8be5\u64cd\u4f5c~",5000202:"\u5f88\u62b1\u6b49\uff0c\u8be5\u5e16\u5df2\u88ab\u7ed3\u5e16\uff0c\u65e0\u6cd5\u56de\u590d~",5002003:"\u5f88\u62b1\u6b49\uff0c\u60a8\u53d1\u5e03\u7684\u5185\u5bb9\u542b\u6709\u654f\u611f\u4fe1\u606f\uff0c\u53d1\u5e03\u4e0d\u6210\u529f\uff01",other:"\u5f88\u62b1\u6b49\uff0c\u51fa\u9519\u4e86\uff01"},d=c[b.code];if(!d&&b.msg&&""!=b.msg)d=b.msg;sdk.common.ui.NoticeBox.error(d||c.other)}});S.SSVW.Topic=Backbone.View.extend({el:"#bbs",isAdd:!1,events:{"submit #postTopicForm":"onPostBtnClicked","click .deleteTopicFileBtn":"deleteTopicFile"},initialize:function(){_.bindAll(this)},edit:function(a,b,c){S.SCEV.Proxy.trigger(S.SCEV.EventType.PRE_ROUTE,{enterPage:sdk.Log.businesses.PAGE_BBS,enterBusiness:["editTopic",a,c]});this.boardId=a;this.controller=this.controller||S.SSCT.GetHandler("Controller","Post");this.isAdd=_.isUndefined(c)?!0:!1;this.renderTopic();if(!this.isAdd)this.topicId=
c,this._showLoading(),this.controller.getTopicInfo({boardId:a,gameId:b,topicId:c,editing:!0},this.controller.callBackMix($.proxy(function(a){this.fillForm(a);this._hideLoading()},this),$.proxy(function(a,b){this.onTopicError(a,b);this._hideLoading()},this)))},renderTopic:function(){$("#postTopicBtn").val({"true":"\u53d1\u8868","false":"\u7f16\u8f91"}[this.isAdd.toString()]);this.$el.find("input,textarea").each(function(a,b){if(_.isEmpty($(b).val()))b.onfocus=function(){_.isEmpty($(this).val())&&$(this).val("")},
$(b).val("")});$("#title").focus()},fillForm:function(a){var a=a.topic,b,c,d;if(!_.isUndefined(a)&&!_.isEmpty(a)){b=this.$el.find("#postTopicForm");c=a.get("files");d=a.get("group");b.find('[name="title"]').val(a.get("title"));b.find('[name="content"]').val(a.get("content"));_.isUndefined(d)||b.find('[name="group"][value="'+d+'"]').attr("checked","checked");if(c&&0<c.length){for(b=0,d=c.length;b<d;b++)c[b].topicId=a.get("topicId"),c[b].boardId=a.get("boardId");this.renderFileList(c)}$("#title").focus()}else this.onError("\u83b7\u53d6\u5e16\u5b50\u4fe1\u606f\u51fa\u9519\u3002")},
renderFileList:function(a){0<a.length?(a=template("topicFile_templ",{list:a}),this.$el.find("#TopicImageListDiv").html(a).show()):this.$el.find("#TopicImageListDiv").html("").hide()},onPostBtnClicked:function(a){a.preventDefault();var b=this.$el.find("#postTopicForm"),c=b.find('[name="title"]'),a=c.val(),d=b.find('[name="content"]'),e=d.val(),b=b.find('[name="group"]:checked').val()||0;this.controller.postTopic({boardid:this.boardId,title:a,content:e,group:b,fileList:this.getFileList(),isAdd:this.isAdd},
{TopicCallback:{success:this.showMessage,error:this.onTopicError},DataError:$.proxy(function(a,b){"title"==(b||"title")?S.common.ui.MsgBox.alert(a,{callBack:function(){c.focus()}}):S.common.ui.MsgBox.alert(a,{callBack:function(){d.focus()}})}),confirm:$.proxy(function(a,b){S.common.ui.MsgBox.confirm(a,{callBack:b.callBack,cancel:b.cancel,confirmName:"\u662f",cancelName:"\u5426"})})});return!1},getFileList:function(){var a=$("input.input_100"),b=[],c,d;for(c=0,d=a.length;c<d;c++)-1!=a[c].id.indexOf("topicFile")&&
b.push({boardid:this.boardId,topicid:this.topicId,fileid:a[c].id.replace("topicFile",""),description:a[c].value});return b},deleteTopicFile:function(a,b){var c=b.getAttribute("data-fileId"),d=this,e={boardid:this.boardId,topicid:this.topicId,fileid:c};sdk.common.ui.MsgBox.confirm("\u786e\u5b9a\u5220\u9664\u8be5\u6587\u4ef6\uff1f",{callBack:function(){d.controller.deleteTopicFile(e,{error:d.onTopicError,success:function(){$("#topicFile"+c).remove()}})}})},showMessage:function(){var a=this.isAdd;S.common.ui.NoticeBox.ok(this.isAdd?
"\u53d1\u8868\u6210\u529f\uff01":"\u4fdd\u5b58\u6210\u529f\uff01",function(){a?sdk.Url.location.route("#!bbs/index/all/1"):S.Url.back()})},onError:function(a){sdk.common.ui.NoticeBox.error(a||"\u64cd\u4f5c\u51fa\u9519")},onTopicError:function(a,b){var c={5000201:"\u5df2\u8d85\u8fc7\u53ef\u5220\u9664\u65f6\u95f4\u9650\u5236\uff0c\u65e0\u6cd5\u8fdb\u884c\u5220\u9664~",5001001:"\u5df2\u8d85\u8fc7\u53ef\u7f16\u8f91\u65f6\u95f4\u9650\u5236\uff0c\u65e0\u6cd5\u8fdb\u884c\u7f16\u8f91~\uff01",5000200:"\u4f60\u7684\u64cd\u4f5c\u592a\u5feb\u4e86\uff0c\u8bf7\u6b47\u4e00\u4f1a\u5427~",
5000020:"\u5f88\u62b1\u6b49\uff0c\u65e0\u6b64\u5e16\u5b50~",5000053:"\u5f88\u62b1\u6b49\uff0c\u4f60\u65e0\u6743\u9650\u8fdb\u884c\u8be5\u64cd\u4f5c~",5000060:"\u5f88\u62b1\u6b49\uff0c\u65e0\u6b64\u6587\u4ef6",5001908:"\u5f88\u62b1\u6b49\uff0c\u60a8\u53d1\u5e03\u7684\u5185\u5bb9\u542b\u6709\u654f\u611f\u4fe1\u606f\uff0c\u53d1\u5e03\u4e0d\u6210\u529f\uff01",408:"\u5f88\u62b1\u6b49\uff0c\u670d\u52a1\u5668\u6ca1\u6709\u53ca\u65f6\u54cd\u5e94",other:"\u5f88\u62b1\u6b49\uff0c\u51fa\u9519\u4e86\uff01"},
d=c[b.code];if(!d&&b.msg&&""!=b.msg)d=b.msg;sdk.common.ui.NoticeBox.error(d||c.other)},_showLoading:function(){if(_.isEmpty(this.loadingEl))this.loadingEl=S.common.ui.NoticeBox.loading()},_hideLoading:function(){if(!_.isEmpty(this.loadingEl))S.common.ui.NoticeBox.hide(this.loadingEl,null,"remove"),this.loadingEl={}}});
